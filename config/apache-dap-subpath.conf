# Apache Configuration for DAP Application at /dap/ subpath
# Suitable for multiple domains and access methods:
#   - myapps.cxsaaslab.com/dap/
#   - myapps.rajarora.csslab/dap/
#   - centos1.rajarora.csslab/dap/
#   - myapps-8321890.ztna.sse.cisco.io/dap/
#   - IP address: 172.22.156.32/dap/
#
# Installation:
# 1. Copy this file to /etc/httpd/conf.d/dap.conf (RHEL/CentOS) or /etc/apache2/sites-available/dap.conf (Debian/Ubuntu)
# 2. Enable required Apache modules
# 3. Restart Apache

# Enable required modules (add to main Apache config if not already enabled):
# LoadModule proxy_module modules/mod_proxy.so
# LoadModule proxy_http_module modules/mod_proxy_http.so
# LoadModule proxy_wstunnel_module modules/mod_proxy_wstunnel.so
# LoadModule rewrite_module modules/mod_rewrite.so
# LoadModule headers_module modules/mod_headers.so

# Consolidated VirtualHost for all HTTP access
<VirtualHost *:80>
    ServerName myapps.cxsaaslab.com
    ServerAlias myapps.rajarora.csslab
    ServerAlias centos1.rajarora.csslab
    ServerAlias 172.22.156.32
    
    # Security Headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    
    # DAP Application at /dap/ path
    Alias /dap /data/dap/frontend/dist
    
    <Directory /data/dap/frontend/dist>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
        
        # Enable rewrite for SPA routing
        RewriteEngine On
        RewriteBase /dap/
        
        # Don't rewrite files that exist
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        
        # Don't rewrite API and GraphQL requests
        RewriteCond %{REQUEST_URI} !^/dap/graphql
        RewriteCond %{REQUEST_URI} !^/dap/api
        
        # Rewrite everything else to index.html
        RewriteRule ^ /dap/index.html [L]
    </Directory>
    
    # GraphQL API Endpoint
    <Location /dap/graphql>
        # WebSocket support
        RewriteEngine On
        RewriteCond %{HTTP:Upgrade} websocket [NC]
        RewriteCond %{HTTP:Connection} upgrade [NC]
        RewriteRule ^/dap/graphql(.*)$ ws://127.0.0.1:4000/graphql$1 [P,L]
        
        # HTTP proxy
        ProxyPass http://127.0.0.1:4000/graphql
        ProxyPassReverse http://127.0.0.1:4000/graphql
        
        # Proxy headers
        ProxyPreserveHost On
        RequestHeader set X-Forwarded-Proto "http"
        RequestHeader set X-Forwarded-Prefix "/dap"
    </Location>
    
    # REST API Endpoints
    <Location /dap/api>
        ProxyPass http://127.0.0.1:4000/api
        ProxyPassReverse http://127.0.0.1:4000/api
        
        # Proxy headers
        ProxyPreserveHost On
        RequestHeader set X-Forwarded-Proto "http"
        RequestHeader set X-Forwarded-Prefix "/dap"
        
        # File upload size (10MB)
        LimitRequestBody 10485760
    </Location>
    
    # Logging
    ErrorLog /var/log/httpd/dap-error.log
    CustomLog /var/log/httpd/dap-access.log combined
</VirtualHost>

# HTTPS Configuration for ZTNA access (DISABLED - No SSL certificates)
# Uncomment and configure if you need HTTPS support
#<VirtualHost *:443>
#    ServerName myapps-8321890.ztna.sse.cisco.io
#    ServerAlias myapps.cxsaaslab.com
#    ServerAlias myapps.rajarora.csslab
#    ServerAlias centos1.rajarora.csslab
#    
#    # SSL Configuration (adjust paths as needed)
#    SSLEngine on
#    SSLCertificateFile /etc/pki/tls/certs/your-cert.crt
#    SSLCertificateKeyFile /etc/pki/tls/private/your-key.key
#    # SSLCertificateChainFile /path/to/chain.pem
#    
#    # Security Headers
#    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
#    Header always set X-Frame-Options "SAMEORIGIN"
#    Header always set X-Content-Type-Options "nosniff"
#    Header always set X-XSS-Protection "1; mode=block"
#    
#    # DAP Application at /dap/ path
#    Alias /dap /data/dap/frontend/dist
#    
#    <Directory /data/dap/frontend/dist>
#        Options -Indexes +FollowSymLinks
#        AllowOverride None
#        Require all granted
#        
#        # Enable rewrite for SPA routing
#        RewriteEngine On
#        RewriteBase /dap/
#        
#        # Don't rewrite files that exist
#        RewriteCond %{REQUEST_FILENAME} !-f
#        RewriteCond %{REQUEST_FILENAME} !-d
#        
#        # Don't rewrite API and GraphQL requests
#        RewriteCond %{REQUEST_URI} !^/dap/graphql
#        RewriteCond %{REQUEST_URI} !^/dap/api
#        
#        # Rewrite everything else to index.html
#        RewriteRule ^ /dap/index.html [L]
#    </Directory>
#    
#    # GraphQL API Endpoint
#    <Location /dap/graphql>
#        # WebSocket support
#        RewriteEngine On
#        RewriteCond %{HTTP:Upgrade} websocket [NC]
#        RewriteCond %{HTTP:Connection} upgrade [NC]
#        RewriteRule ^/dap/graphql(.*)$ ws://127.0.0.1:4000/graphql$1 [P,L]
#        
#        # HTTP proxy
#        ProxyPass http://127.0.0.1:4000/graphql
#        ProxyPassReverse http://127.0.0.1:4000/graphql
#        
#        # Proxy headers
#        ProxyPreserveHost On
#        RequestHeader set X-Forwarded-Proto "https"
#        RequestHeader set X-Forwarded-Prefix "/dap"
#    </Location>
#    
#    # REST API Endpoints
#    <Location /dap/api>
#        ProxyPass http://127.0.0.1:4000/api
#        ProxyPassReverse http://127.0.0.1:4000/api
#        
#        # Proxy headers
#        ProxyPreserveHost On
#        RequestHeader set X-Forwarded-Proto "https"
#        RequestHeader set X-Forwarded-Prefix "/dap"
#        
#        # File upload size (10MB)
#        LimitRequestBody 10485760
#    </Location>
#    
#    # Logging
#    ErrorLog /var/log/httpd/dap-ssl-error.log
#    CustomLog /var/log/httpd/dap-ssl-access.log combined
#</VirtualHost>


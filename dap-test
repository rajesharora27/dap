#!/bin/bash

# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘ DAP Test Runner Script                                                       â•‘
# â•‘ Consolidated testing for the DAP Application                                 â•‘
# â•‘                                                                              â•‘
# â•‘ Commands: all, unit, e2e, crud, tags, integration, coverage, help           â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

set -e

# ================================
# Configuration
# ================================
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$SCRIPT_DIR"
BACKEND_DIR="$PROJECT_DIR/backend"
FRONTEND_DIR="$PROJECT_DIR/frontend"
TESTS_DIR="$PROJECT_DIR/tests"

# Database containers
DB_CONTAINER=$(docker ps --format "{{.Names}}" 2>/dev/null | grep -E "dap[-_](db|postgres)" | head -1 || echo "")

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# ================================
# Logging Functions
# ================================
log_info() {
    echo -e "${BLUE}â„¹ ${NC}$1"
}

log_success() {
    echo -e "${GREEN}âœ” ${NC}$1"
}

log_warning() {
    echo -e "${YELLOW}âš  ${NC}$1"
}

log_error() {
    echo -e "${RED}âœ– ${NC}$1"
}

log_header() {
    echo ""
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}  $1${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
}

# ================================
# Platform Detection
# ================================
use_mac_mode() {
    [[ "$(uname)" == "Darwin" ]]
}

get_current_user() {
    whoami
}

# ================================
# Database Helpers
# ================================
ensure_test_database() {
    log_info "â³ Ensuring test database exists..."
    
    if use_mac_mode; then
        local current_user=$(get_current_user)
        if ! psql -h localhost -p 5432 -lqt 2>/dev/null | cut -d \| -f 1 | grep -qw 'dap_test'; then
            log_info "ðŸ“ Creating test database..."
            createdb -h localhost -p 5432 dap_test 2>/dev/null || true
        fi
        export DATABASE_URL="postgresql://${current_user}@localhost:5432/dap_test?schema=public"
    else
        if [ -n "$DB_CONTAINER" ]; then
            if ! docker exec $DB_CONTAINER psql -U postgres -c '\l' 2>/dev/null | grep -q 'dap_test'; then
                log_info "ðŸ“ Creating test database..."
                docker exec $DB_CONTAINER psql -U postgres -c "CREATE DATABASE dap_test;" 2>/dev/null || true
            fi
        fi
        export DATABASE_URL="postgres://postgres:postgres@localhost:5432/dap_test?schema=public"
    fi
    
    log_success "âœ… Test database ready"
}

run_migrations_on_test_db() {
    log_info "ðŸ”„ Running migrations on test database..."
    cd "$BACKEND_DIR"
    npx prisma migrate deploy --skip-generate 2>/dev/null || npx prisma db push --skip-generate 2>/dev/null || true
    log_success "âœ… Test database schema ready"
}

# ================================
# Test Runners
# ================================

# Run comprehensive E2E CRUD test suite
run_comprehensive_test() {
    log_header "COMPREHENSIVE E2E TEST (Shadow Database)"
    
    echo ""
    log_info "ðŸ“ Working Directory: $BACKEND_DIR"
    log_info "ðŸ—ƒï¸  Database: dap_test (shadow copy - dev data protected!)"
    log_info "ðŸ”§ NODE_ENV: test"
    log_info "ðŸ” Test: comprehensive-crud (38 tests)"
    echo ""
    
    ensure_test_database
    
    cd "$BACKEND_DIR"
    run_migrations_on_test_db
    
    export NODE_ENV="test"
    export CI="true"
    
    echo ""
    log_info "ðŸ’» Running E2E tests..."
    echo -e "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo ""
    
    if npm test -- --runInBand --passWithNoTests --testPathPattern="comprehensive-crud"; then
        echo ""
        echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        log_success "ðŸŽ‰ COMPREHENSIVE E2E TEST PASSED!"
        echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        log_info "All 38 tests passed:"
        log_info "âœ… Product CRUD (create, read, update, delete, outcomes, releases, licenses)"
        log_info "âœ… Task CRUD (create, read, update, delete, telemetry, reorder)"
        log_info "âœ… Solution CRUD (create, read, update, add/remove products)"
        log_info "âœ… Customer CRUD (create, read, update, delete)"
        log_info "âœ… Adoption Plans (assign products, create/update/delete plans)"
        log_info "âœ… Import/Export (full data export, custom attributes)"
        log_info "âœ… Telemetry Evaluation (success criteria, multiple data types)"
        echo ""
        return 0
    else
        echo ""
        echo -e "${RED}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        log_error "âŒ COMPREHENSIVE E2E TEST FAILED!"
        echo -e "${RED}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        log_warning "Check the test output above for specific failures"
        log_info "Fix any issues and run './dap-test e2e' again"
        return 1
    fi
}

# Run tags implementation test
run_tags_test() {
    log_header "TAGS IMPLEMENTATION TEST (Shadow Database)"
    
    echo ""
    log_info "ðŸ“ Working Directory: $BACKEND_DIR"
    log_info "ðŸ—ƒï¸  Database: dap_test (shadow copy - dev data protected!)"
    log_info "ðŸ”§ NODE_ENV: test"
    log_info "ðŸ” Test: tags-implementation"
    echo ""
    
    ensure_test_database
    
    cd "$BACKEND_DIR"
    run_migrations_on_test_db
    
    export NODE_ENV="test"
    export CI="true"
    
    echo ""
    log_info "ðŸ’» Running Tags tests..."
    echo -e "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo ""
    
    if npm test -- --runInBand --passWithNoTests --testPathPattern="tags"; then
        echo ""
        log_success "ðŸŽ‰ TAGS TESTS PASSED!"
        return 0
    else
        echo ""
        log_error "âŒ TAGS TESTS FAILED!"
        return 1
    fi
}

# Run integration tests
run_integration_tests() {
    log_header "INTEGRATION TESTS (Shadow Database)"
    
    echo ""
    log_info "ðŸ“ Working Directory: $BACKEND_DIR"
    log_info "ðŸ—ƒï¸  Database: dap_test (shadow copy - dev data protected!)"
    log_info "ðŸ”§ NODE_ENV: test"
    log_info "ðŸ” Test: integration"
    echo ""
    
    ensure_test_database
    
    cd "$BACKEND_DIR"
    run_migrations_on_test_db
    
    export NODE_ENV="test"
    export CI="true"
    
    echo ""
    log_info "ðŸ’» Running integration tests..."
    echo -e "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo ""
    
    if npm test -- --runInBand --passWithNoTests --testPathPattern="integration"; then
        echo ""
        log_success "ðŸŽ‰ INTEGRATION TESTS PASSED!"
        return 0
    else
        echo ""
        log_error "âŒ INTEGRATION TESTS FAILED!"
        return 1
    fi
}

# Run unit tests with optional pattern and coverage
run_unit_tests() {
    log_header "UNIT & INTEGRATION TESTS (Shadow Database)"
    
    # Parse optional arguments
    local pattern=""
    local coverage=false
    
    while [ "$#" -gt 0 ]; do
        case "$1" in
            --pattern=*)
                pattern="${1#*=}"
                log_info "ðŸ” Test Pattern: $pattern"
                ;;
            --coverage)
                coverage=true
                log_info "ðŸ“Š Coverage: enabled"
                ;;
            *)
                pattern="$1"
                log_info "ðŸ” Test Pattern: $pattern"
                ;;
        esac
        shift
    done
    
    echo ""
    log_info "ðŸ“ Working Directory: $BACKEND_DIR"
    log_info "ðŸ—ƒï¸  Database: dap_test (shadow copy - dev data protected!)"
    log_info "ðŸ”§ NODE_ENV: test"
    echo ""
    
    ensure_test_database
    
    cd "$BACKEND_DIR"
    run_migrations_on_test_db
    
    # Build the command
    local test_cmd="npm test -- --runInBand --passWithNoTests"
    
    if [ "$coverage" = true ]; then
        test_cmd="npm test -- --coverage --runInBand --passWithNoTests"
    fi
    
    if [ -n "$pattern" ]; then
        test_cmd="$test_cmd --testPathPattern=\"$pattern\""
    fi
    
    export NODE_ENV="test"
    export CI="true"
    
    echo ""
    log_info "ðŸ’» Command: $test_cmd"
    echo -e "${CYAN}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo ""
    
    if eval "$test_cmd"; then
        echo ""
        echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        log_success "âœ… Tests PASSED!"
        echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        
        # Show coverage summary if enabled
        if [ "$coverage" = true ] && [ -f "coverage/coverage-summary.json" ]; then
            echo ""
            log_info "ðŸ“Š Coverage Summary:"
            cat coverage/coverage-summary.json | jq -r '.total | "   Lines: \(.lines.pct)% | Statements: \(.statements.pct)% | Functions: \(.functions.pct)% | Branches: \(.branches.pct)%"' 2>/dev/null || true
        fi
        
        return 0
    else
        echo ""
        echo -e "${RED}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        log_error "âŒ Tests FAILED!"
        echo -e "${RED}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        return 1
    fi
}

# Run all tests
run_all_tests() {
    log_header "RUNNING ALL TESTS"
    
    local failed=0
    
    # E2E Tests
    log_info "Running E2E CRUD tests..."
    if ! run_comprehensive_test; then
        failed=1
    fi
    
    echo ""
    
    # Tags Tests
    log_info "Running Tags tests..."
    if ! run_tags_test; then
        failed=1
    fi
    
    echo ""
    
    # Integration Tests
    log_info "Running Integration tests..."
    if ! run_integration_tests; then
        failed=1
    fi
    
    echo ""
    
    if [ $failed -eq 0 ]; then
        log_header "ALL TESTS PASSED! ðŸŽ‰"
        return 0
    else
        log_header "SOME TESTS FAILED âŒ"
        return 1
    fi
}

# Run legacy test scripts from tests/ directory
run_legacy_test() {
    local test_file="$1"
    
    if [ -z "$test_file" ]; then
        log_error "No test file specified"
        log_info "Available tests in tests/ directory:"
        ls -1 "$TESTS_DIR"/*.js 2>/dev/null | xargs -n1 basename || echo "  (no test files found)"
        return 1
    fi
    
    local test_path="$TESTS_DIR/$test_file"
    
    if [ ! -f "$test_path" ]; then
        # Try with .js extension
        test_path="$TESTS_DIR/${test_file}.js"
    fi
    
    if [ ! -f "$test_path" ]; then
        log_error "Test file not found: $test_file"
        return 1
    fi
    
    log_header "RUNNING LEGACY TEST: $test_file"
    node "$test_path"
}

# ================================
# Help
# ================================
show_help() {
    echo -e "${PURPLE}DAP Test Runner${NC}"
    echo ""
    echo "Consolidated test runner for the DAP application."
    echo ""
    echo "Usage: $0 [command] [options]"
    echo ""
    echo "Commands:"
    echo -e "  ${GREEN}all${NC}           - Run all test suites (e2e, tags, integration)"
    echo -e "  ${GREEN}e2e${NC}           - Run comprehensive E2E CRUD tests (38 tests)"
    echo -e "  ${GREEN}crud${NC}          - Alias for e2e"
    echo -e "  ${CYAN}unit${NC}          - Run unit tests (optional: pattern, --coverage)"
    echo -e "  ${CYAN}tags${NC}          - Run tags implementation tests"
    echo -e "  ${CYAN}integration${NC}   - Run GraphQL integration tests"
    echo -e "  ${YELLOW}coverage${NC}      - Run all tests with coverage report"
    echo -e "  ${BLUE}legacy${NC}        - Run legacy test scripts from tests/ directory"
    echo -e "  ${BLUE}list${NC}          - List available test files"
    echo -e "  ${PURPLE}help${NC}          - Show this help message"
    echo ""
    echo "Examples:"
    echo "  $0 all                         # Run all tests"
    echo "  $0 e2e                         # Run E2E CRUD tests"
    echo "  $0 unit                        # Run all unit tests"
    echo "  $0 unit auth                   # Run only auth tests"
    echo "  $0 unit --coverage             # Run with coverage"
    echo "  $0 tags                        # Run tags tests"
    echo "  $0 integration                 # Run integration tests"
    echo "  $0 legacy test-adoption-sync   # Run legacy test script"
    echo "  $0 list                        # List available test files"
    echo ""
    echo "Test Database:"
    echo "  All tests run against 'dap_test' database (shadow copy)"
    echo "  Your development data in 'dap' database is NEVER touched"
    echo ""
    echo "Test Suites:"
    echo "  â€¢ E2E/CRUD: Full end-to-end CRUD operations (38 tests)"
    echo "  â€¢ Tags: Tag management and filtering"
    echo "  â€¢ Integration: GraphQL API tests (products, solutions, customers)"
    echo "  â€¢ Unit: Individual component tests"
    echo ""
    echo "Test Locations:"
    echo "  â€¢ Backend E2E:     backend/src/__tests__/e2e/"
    echo "  â€¢ Backend Unit:    backend/src/__tests__/"
    echo "  â€¢ Backend Services: backend/src/__tests__/services/"
    echo "  â€¢ Integration:     backend/src/__tests__/integration/"
    echo "  â€¢ Frontend:        frontend/src/__tests__/"
    echo "  â€¢ Legacy Scripts:  tests/"
}

list_tests() {
    log_header "AVAILABLE TESTS"
    
    echo -e "${GREEN}Backend E2E Tests:${NC}"
    ls -1 "$BACKEND_DIR/src/__tests__/e2e/"*.ts 2>/dev/null | xargs -n1 basename || echo "  (none)"
    echo ""
    
    echo -e "${GREEN}Backend Integration Tests:${NC}"
    ls -1 "$BACKEND_DIR/src/__tests__/integration/"*.ts 2>/dev/null | xargs -n1 basename || echo "  (none)"
    echo ""
    
    echo -e "${GREEN}Backend Unit Tests:${NC}"
    ls -1 "$BACKEND_DIR/src/__tests__/"*.ts 2>/dev/null | xargs -n1 basename || echo "  (none)"
    echo ""
    
    echo -e "${GREEN}Backend Service Tests:${NC}"
    ls -1 "$BACKEND_DIR/src/__tests__/services/"*.ts 2>/dev/null | xargs -n1 basename || echo "  (none)"
    echo ""
    
    echo -e "${GREEN}Frontend Tests:${NC}"
    ls -1 "$FRONTEND_DIR/src/__tests__/"*.tsx 2>/dev/null | xargs -n1 basename || echo "  (none)"
    ls -1 "$FRONTEND_DIR/src/__tests__/"*.ts 2>/dev/null | xargs -n1 basename || echo ""
    echo ""
    
    echo -e "${YELLOW}Legacy Test Scripts (tests/):${NC}"
    ls -1 "$TESTS_DIR/"*.js 2>/dev/null | xargs -n1 basename || echo "  (none)"
}

# ================================
# Main
# ================================
main() {
    cd "$PROJECT_DIR"
    
    case "${1:-}" in
        all)
            run_all_tests
            ;;
        e2e|crud|comprehensive)
            run_comprehensive_test
            ;;
        unit)
            shift
            run_unit_tests "$@"
            ;;
        tags)
            run_tags_test
            ;;
        integration)
            run_integration_tests
            ;;
        coverage)
            shift
            run_unit_tests --coverage "$@"
            ;;
        legacy)
            shift
            run_legacy_test "$@"
            ;;
        list)
            list_tests
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            if [ -n "${1:-}" ]; then
                log_error "Unknown command: $1"
                echo ""
            fi
            show_help
            ;;
    esac
}

# Run main function with all arguments
main "$@"

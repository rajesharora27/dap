// =============================================================================
// DAP DATABASE SCHEMA
// =============================================================================
// Database: PostgreSQL 16
// ORM: Prisma 5.x
// Documentation: docs/SCHEMA_REFERENCE.md
// =============================================================================

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["debian-openssl-1.1.x", "debian-openssl-3.0.x", "linux-musl", "linux-musl-openssl-3.0.x", "native", "darwin-arm64"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// USER & AUTHENTICATION
// =============================================================================
// Core user management with role-based access control (RBAC).
// Sessions track active user sessions with entity locking support.
// =============================================================================

/// User account with authentication and authorization
model User {
  id                 String       @id @default(cuid())
  email              String       @unique
  username           String       @unique
  name               String?
  fullName           String?      @default("")
  role               SystemRole   @default(USER)
  password           String
  isAdmin            Boolean      @default(false)
  isActive           Boolean      @default(true)
  mustChangePassword Boolean      @default(true)
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @default(now()) @updatedAt
  auditLogs          AuditLog[]
  changeSets         ChangeSet[]
  sessions           Session[]
  permissions        Permission[]
  userRoles          UserRole[]
  grantedPermissions Permission[] @relation("GrantedBy")
  diaryTodos         DiaryTodo[]
  diaryBookmarks     DiaryBookmark[]
}

/// Active user session with expiration tracking
model Session {
  id             String         @id @default(cuid())
  userId         String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  expiresAt      DateTime
  lockedEntities LockedEntity[]
  user           User           @relation(fields: [userId], references: [id])
  
  @@index([expiresAt])  // Fast expired session cleanup
}

/// Entity lock for concurrent editing prevention
model LockedEntity {
  id         String   @id @default(cuid())
  entityType String
  entityId   String
  sessionId  String
  createdAt  DateTime @default(now())
  expiresAt  DateTime
  session    Session  @relation(fields: [sessionId], references: [id])

  @@index([entityType, entityId])
}

// =============================================================================
// APPLICATION SETTINGS
// =============================================================================
// Runtime-configurable application settings stored in database.
// Settings override environment variables when present.
// =============================================================================

/// Application setting for runtime configuration
model AppSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  dataType    String   @default("string") // string, number, boolean, json
  category    String   @default("general") // security, ai, performance, ui
  label       String   // Human-readable label for UI
  description String?  // Help text shown in UI
  isSecret    Boolean  @default(false) // If true, value is masked in UI
  updatedAt   DateTime @default(now()) @updatedAt
  updatedBy   String?  // userId who last changed this setting

  @@index([category])
}

// =============================================================================
// PRODUCT DOMAIN
// =============================================================================
// Products are the core entities containing tasks, licenses, outcomes, and
// releases. Products can be bundled into solutions and assigned to customers.
// =============================================================================

/// Product definition with tasks and configurations
model Product {
  id               String            @id @default(cuid())
  name             String            @unique
  description      String?
  resources        Json?             // List of links: { label: string, url: string }[]
  customAttrs      Json?             // Legacy - will be replaced by CustomAttribute model
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  deletedAt        DateTime?
  customers        CustomerProduct[]
  licenses         License[]
  solutions        SolutionProduct[]
  tags          ProductTag[]
  tasks         Task[]
  // existing fields remain
  outcomes         Outcome[]
  releases         Release[]
  customAttributes CustomAttribute[] // New structured custom attributes
  
  @@index([deletedAt])  // Fast soft-delete filtering
}

// =============================================================================
// SOLUTION DOMAIN
// =============================================================================
// Solutions bundle multiple products into cohesive offerings.
// They can have their own tasks, licenses, outcomes, and releases.
// =============================================================================

/// Solution bundling multiple products
model Solution {
  id          String              @id @default(cuid())
  name        String
  description String?
  resources   Json?               // List of links: { label: string, url: string }[]
  customAttrs Json?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  deletedAt   DateTime?
  customers   CustomerSolution[]
  licenses    License[]
  products    SolutionProduct[]
  tasks       Task[]
  releases    Release[]
  outcomes    Outcome[]
  taskOrders  SolutionTaskOrder[]
  tags        SolutionTag[]
}

model SolutionProduct {
  id         String   @id @default(cuid())
  productId  String
  solutionId String
  order      Int      @default(0)
  product    Product  @relation(fields: [productId], references: [id])
  solution   Solution @relation(fields: [solutionId], references: [id])

  @@unique([productId, solutionId])
}

// =============================================================================
// CUSTOMER DOMAIN
// =============================================================================
// Customers can be assigned products and solutions. Each assignment creates
// an adoption plan with tasks that track implementation progress.
// =============================================================================

/// Customer organization
model Customer {
  id          String             @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  deletedAt   DateTime?
  products    CustomerProduct[]
  solutions   CustomerSolution[]
}

model CustomerProduct {
  id                String              @id @default(cuid())
  customerId        String
  productId         String
  name              String              // Required name/identifier for this product assignment (e.g., "Production", "Development")
  customerSolutionId String?            // Links to parent solution if assigned as part of a solution
  
  // License and Outcomes Selection
  licenseLevel      LicenseLevel        @default(ESSENTIAL)
  selectedOutcomes  Json?               // Array of outcome IDs customer selected
  selectedReleases  Json?               // Array of release IDs customer selected
  
  // Metadata
  purchasedAt       DateTime            @default(now())
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  // Relations
  customer          Customer            @relation(fields: [customerId], references: [id], onDelete: Cascade)
  product           Product             @relation(fields: [productId], references: [id], onDelete: Cascade)
  customerSolution  CustomerSolution?   @relation(fields: [customerSolutionId], references: [id], onDelete: Cascade)
  adoptionPlan      AdoptionPlan?       // One adoption plan per product assignment
  tags              CustomerProductTag[]
  
  @@index([customerId])
  @@index([productId])
  @@index([customerSolutionId])
}

model CustomerSolution {
  id                String                @id @default(cuid())
  customerId        String
  solutionId        String
  name              String                // Required name/identifier (e.g., "Enterprise Security Bundle", "Branch Office Package")
  
  // License and Selections
  licenseLevel      LicenseLevel          @default(ESSENTIAL)
  selectedOutcomes  Json?                 // Array of outcome IDs (both solution AND product outcomes)
  selectedReleases  Json?                 // Array of release IDs (both solution AND product releases)
  
  // Metadata
  purchasedAt       DateTime              @default(now())
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  
  // Relations
  customer          Customer              @relation(fields: [customerId], references: [id], onDelete: Cascade)
  solution          Solution              @relation(fields: [solutionId], references: [id], onDelete: Cascade)
  adoptionPlan      SolutionAdoptionPlan? // One adoption plan per solution assignment
  products          CustomerProduct[]     // Products created from this solution
  tags              CustomerSolutionTag[]

  @@unique([customerId, solutionId, name])
  @@index([customerId])
  @@index([solutionId])
}

model AdoptionPlan {
  id                  String              @id @default(cuid())
  customerProductId   String              @unique
  
  // Snapshot of product details at time of creation
  productId           String              // Reference to original product
  productName         String              // Snapshot of product name
  licenseLevel        LicenseLevel        // License level when created
  selectedOutcomes    Json?               // Outcome IDs when created
  selectedReleases    Json?               // Release IDs when created
  
  // Progress tracking
  totalTasks          Int                 @default(0)
  completedTasks      Int                 @default(0)
  totalWeight         Decimal             @default(0) @db.Decimal(10, 2)
  completedWeight     Decimal             @default(0) @db.Decimal(10, 2)
  progressPercentage  Decimal             @default(0) @db.Decimal(5, 2)
  
  // Metadata
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  lastSyncedAt        DateTime?           // Last time synced with product changes
  
  // Relations
  customerProduct     CustomerProduct     @relation(fields: [customerProductId], references: [id], onDelete: Cascade)
  tasks               CustomerTask[]
  filterPreference    AdoptionPlanFilterPreference?
  
  @@index([customerProductId])
  @@index([productId])
}

// Filter preferences for adoption plans - persisted across sessions
model AdoptionPlanFilterPreference {
  id                  String       @id @default(cuid())
  adoptionPlanId      String       @unique
  
  filterReleases      String[]     // Array of release IDs to filter by
  filterOutcomes      String[]     // Array of outcome IDs to filter by
  filterTags          String[]     // Array of tag IDs to filter by
  
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  
  adoptionPlan        AdoptionPlan @relation(fields: [adoptionPlanId], references: [id], onDelete: Cascade)
}

model CustomerTask {
  id                    String                    @id @default(cuid())
  adoptionPlanId        String
  
  // Snapshot of original task
  originalTaskId        String                    // Reference to product task
  name                  String
  description           String?
  estMinutes            Int
  weight                Decimal                   @db.Decimal(5, 2)
  sequenceNumber        Int
  howToDoc              String[]
  howToVideo            String[]
  notes                 String?
  licenseLevel          LicenseLevel
  
  // Customer-specific status
  status                CustomerTaskStatus        @default(NOT_STARTED)
  statusUpdatedAt       DateTime?
  statusUpdatedBy       String?                   // User ID or "telemetry"
  statusUpdateSource    StatusUpdateSource?       // How the status was updated (MANUAL, TELEMETRY, IMPORT, SYSTEM)
  statusNotes           String?                   // Why status changed
  
  // Completion tracking
  isComplete            Boolean                   @default(false)
  completedAt           DateTime?
  completedBy           String?                   // User ID or "telemetry"
  
  // Metadata
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  // Relations
  adoptionPlan          AdoptionPlan              @relation(fields: [adoptionPlanId], references: [id], onDelete: Cascade)
  telemetryAttributes   CustomerTelemetryAttribute[]
  taskTags              CustomerTaskTag[]
  outcomes              CustomerTaskOutcome[]
  releases              CustomerTaskRelease[]
  
  @@index([adoptionPlanId])
  @@index([originalTaskId])
  @@index([status])
}

model CustomerTelemetryAttribute {
  id                    String                      @id @default(cuid())
  customerTaskId        String?
  customerSolutionTaskId String?
  
  // Snapshot of original telemetry attribute
  originalAttributeId String?                   // Reference to product telemetry attribute
  name              String
  description       String?
  dataType          TelemetryDataType
  isRequired        Boolean                     @default(false)
  successCriteria   Json                        // Same structure as TelemetryAttribute
  order             Int                         @default(0)
  
  // Customer-specific tracking
  isActive          Boolean                     @default(true)
  isMet             Boolean                     @default(false)
  lastCheckedAt     DateTime?
  
  // Metadata
  createdAt         DateTime                    @default(now())
  updatedAt         DateTime                    @updatedAt
  
  // Relations
  customerTask          CustomerTask?            @relation(fields: [customerTaskId], references: [id], onDelete: Cascade)
  customerSolutionTask  CustomerSolutionTask?    @relation(fields: [customerSolutionTaskId], references: [id], onDelete: Cascade)
  values                CustomerTelemetryValue[]
  
  @@unique([customerTaskId, name])
  @@unique([customerSolutionTaskId, name])
  @@index([customerTaskId])
  @@index([customerSolutionTaskId])
}

model CustomerTelemetryValue {
  id                        String                     @id @default(cuid())
  customerAttributeId       String
  
  // Value details
  value                     Json
  source                    String?                    // "manual", "api", "customer_system"
  batchId                   String?
  notes                     String?
  
  // Metadata
  createdAt                 DateTime                   @default(now())
  
  // Relations
  customerAttribute         CustomerTelemetryAttribute @relation(fields: [customerAttributeId], references: [id], onDelete: Cascade)
  
  @@index([customerAttributeId])
  @@index([batchId])
  @@index([createdAt])
}

model CustomerTaskOutcome {
  id                      String                @id @default(cuid())
  customerTaskId          String?
  customerSolutionTaskId  String?
  outcomeId               String
  customerTask            CustomerTask?         @relation(fields: [customerTaskId], references: [id], onDelete: Cascade)
  customerSolutionTask    CustomerSolutionTask? @relation(fields: [customerSolutionTaskId], references: [id], onDelete: Cascade)
  outcome                 Outcome               @relation(fields: [outcomeId], references: [id], onDelete: Cascade)
  
  @@unique([customerTaskId, outcomeId])
  @@unique([customerSolutionTaskId, outcomeId])
  @@index([customerTaskId])
  @@index([customerSolutionTaskId])
  @@index([outcomeId])
}

model CustomerTaskRelease {
  id                      String                @id @default(cuid())
  customerTaskId          String?
  customerSolutionTaskId  String?
  releaseId               String
  customerTask            CustomerTask?         @relation(fields: [customerTaskId], references: [id], onDelete: Cascade)
  customerSolutionTask    CustomerSolutionTask? @relation(fields: [customerSolutionTaskId], references: [id], onDelete: Cascade)
  release                 Release               @relation(fields: [releaseId], references: [id], onDelete: Cascade)
  
  @@unique([customerTaskId, releaseId])
  @@unique([customerSolutionTaskId, releaseId])
  @@index([customerTaskId])
  @@index([customerSolutionTaskId])
  @@index([releaseId])
}

// =============================================================================
// TASK MODEL
// =============================================================================
// Tasks are the core unit of work. They belong to either a Product or Solution
// and can be linked to outcomes, releases, and telemetry attributes.
// =============================================================================

/// Task definition with weight, sequence, and telemetry
model Task {
  id                  String           @id @default(cuid())
  productId           String?
  solutionId          String?
  name                String
  description         String?
  estMinutes          Int
  notes               String?
  weight              Decimal          @default(0) @db.Decimal(5, 2)
  sequenceNumber      Int
  licenseLevel        LicenseLevel     @default(ESSENTIAL)
  howToDoc            String[]         // HTTP links explaining how to implement the task
  howToVideo          String[]         // Links to videos explaining how to implement the task
  rawTelemetryMapping String?
  completedAt         DateTime?
  completedReason     String?
  softDeleteQueued    Boolean          @default(false)
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  deletedAt           DateTime?
  product             Product?              @relation(fields: [productId], references: [id])
  solution            Solution?             @relation(fields: [solutionId], references: [id])
  telemetry           Telemetry[]
  telemetryAttributes TelemetryAttribute[]
  outcomes            TaskOutcome[]
  releases            TaskRelease[]
  taskTags           TaskTag[]
  solutionTaskTags    SolutionTaskTag[]

  @@index([productId, sequenceNumber])
  @@index([solutionId, sequenceNumber])
}



model License {
  id          String    @id @default(cuid())
  name        String
  description String?
  level       Int       @default(1)      // Hierarchical level (1=lowest, higher numbers include lower levels)
  isActive    Boolean   @default(true)   // Whether this license is currently active
  productId   String?
  solutionId  String?
  customAttrs Json?          // For storing productLicenseMapping etc.
  displayOrder Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  product     Product?  @relation(fields: [productId], references: [id])
  solution    Solution? @relation(fields: [solutionId], references: [id])
  
  @@unique([solutionId, productId])
}

model ProductTag {
  id           String   @id @default(cuid())
  productId    String
  name         String
  description  String?
  color        String?   // Theme color key
  displayOrder Int       @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  taskTags     TaskTag[]
  @@unique([productId, name])
  @@index([productId])
}

model TaskTag {
  id        String   @id @default(cuid())
  taskId    String
  tagId     String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  tag       ProductTag @relation(fields: [tagId], references: [id], onDelete: Cascade)
  @@unique([taskId, tagId])
  @@index([taskId])
  @@index([tagId])
}

model CustomerProductTag {
  id                String   @id @default(cuid())
  customerProductId String
  sourceTagId       String?  // Reference to original ProductTag for sync
  name              String
  description       String?
  color             String?
  displayOrder      Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  customerProduct   CustomerProduct @relation(fields: [customerProductId], references: [id], onDelete: Cascade)
  taskTags          CustomerTaskTag[]
  @@unique([customerProductId, name])
  @@index([customerProductId])
}

model CustomerTaskTag {
  id                    String   @id @default(cuid())
  customerTaskId        String
  tagId                 String
  customerTask          CustomerTask @relation(fields: [customerTaskId], references: [id], onDelete: Cascade)
  tag                   CustomerProductTag @relation(fields: [tagId], references: [id], onDelete: Cascade)
  @@unique([customerTaskId, tagId])
  @@index([customerTaskId])
  @@index([tagId])
}

// =============================================================================
// TELEMETRY SYSTEM
// =============================================================================
// Telemetry tracks real-world usage data for tasks. Attributes define what
// to measure, values store historical data, and success criteria determine
// when a task is considered complete based on telemetry.
// =============================================================================

/// Legacy telemetry data storage (deprecated, use TelemetryAttribute)
model Telemetry {
  id        String   @id @default(cuid())
  taskId    String
  data      Json
  createdAt DateTime @default(now())
  expiresAt DateTime @default(dbgenerated("(now() + '30 days'::interval)"))
  task      Task     @relation(fields: [taskId], references: [id])

  @@index([taskId])
}

model TelemetryAttribute {
  id              String                @id @default(cuid())
  taskId          String
  name            String                // e.g., "login_enabled", "user_count", "location"
  description     String?
  dataType        TelemetryDataType     @default(STRING)
  isRequired      Boolean               @default(false)   // Whether this attribute is mandatory for task completion
  successCriteria Json                  // Flexible criteria definition supporting AND/OR logic
  order           Int                   @default(0)       // Display order in UI
  isActive        Boolean               @default(true)    // Whether this attribute is currently being tracked
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  task            Task                  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  values          TelemetryValue[]

  @@unique([taskId, name])
  @@index([taskId])
}

model TelemetryValue {
  id          String             @id @default(cuid())
  attributeId String
  value       Json               // Actual data value (boolean, number, string, etc.)
  source      String?            // Source of data: "manual", "api", "database", "external_system"
  batchId     String?            // For grouping daily batch updates
  notes       String?            // Optional notes about this value
  createdAt   DateTime           @default(now())
  attribute   TelemetryAttribute @relation(fields: [attributeId], references: [id], onDelete: Cascade)

  @@index([attributeId])
  @@index([batchId])
  @@index([createdAt])
}

// =============================================================================
// AUDIT & HISTORY
// =============================================================================
// AuditLog tracks user actions for compliance and debugging.
// ChangeSet/ChangeItem provide detailed before/after snapshots for changes.
// =============================================================================

/// Audit log entry for user actions
model AuditLog {
  id           String   @id @default(cuid())
  userId       String?
  action       String
  entity       String?
  entityId     String?
  details      Json?
  resourceType String?
  resourceId   String?
  ipAddress    String?
  createdAt    DateTime @default(now())
  user         User?    @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([createdAt])
}

model ChangeSet {
  id          String       @id @default(cuid())
  userId      String?
  createdAt   DateTime     @default(now())
  committedAt DateTime?
  items       ChangeItem[]
  user        User?        @relation(fields: [userId], references: [id])
}

model ChangeItem {
  id          String    @id @default(cuid())
  changeSetId String
  entityType  String
  entityId    String
  before      Json?
  after       Json?
  createdAt   DateTime  @default(now())
  changeSet   ChangeSet @relation(fields: [changeSetId], references: [id])
}

// =============================================================================
// ENUMS
// =============================================================================
// Business domain enumerations for type-safe status and level tracking.
// =============================================================================

/// User system roles for RBAC
enum SystemRole {
  ADMIN
  USER
  SME
  CSS
  VIEWER
}

enum LicenseLevel {
  ESSENTIAL
  ADVANTAGE
  SIGNATURE
}

enum TelemetryDataType {
  BOOLEAN
  NUMBER
  STRING
  TIMESTAMP
  JSON
}

enum CustomAttributeDataType {
  TEXT
  NUMBER
  DATE
  BOOLEAN
  JSON
}

enum CustomerTaskStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  DONE
  NOT_APPLICABLE
  NO_LONGER_USING  // Feature was implemented but telemetry shows it's no longer being used
}

enum StatusUpdateSource {
  MANUAL      // Updated via GUI by user
  TELEMETRY   // Automatically updated via telemetry evaluation
  IMPORT      // Updated via CSV import
  SYSTEM      // Updated by system (e.g., adoption plan creation)
}

enum TaskSourceType {
  SOLUTION    // Task belongs to solution itself
  PRODUCT     // Task comes from a product within solution
}

enum SolutionProductStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  BLOCKED
  SKIPPED
}

model CustomAttribute {
  id             String                  @id @default(cuid())
  productId      String
  product        Product                 @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  attributeName  String                  @db.VarChar(255)
  attributeValue String?                 @db.Text
  dataType       CustomAttributeDataType @default(TEXT)
  description    String?                 @db.VarChar(500)
  isRequired     Boolean                 @default(false)
  displayOrder   Int?
  
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt
  
  @@unique([productId, attributeName])
  @@index([productId])
}

model Outcome {
  id            String                @id @default(cuid())
  productId     String?               // Make optional - can be product OR solution
  solutionId    String?               // Add solution support
  name          String
  description   String?
  displayOrder  Int                   @default(0)
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  product       Product?              @relation(fields: [productId], references: [id], onDelete: Cascade)
  solution      Solution?             @relation(fields: [solutionId], references: [id], onDelete: Cascade)
  tasks         TaskOutcome[]
  customerTasks CustomerTaskOutcome[]

  @@unique([productId, name])
  @@unique([solutionId, name])
  @@index([productId])
  @@index([solutionId])
}

model TaskOutcome {
  id        String  @id @default(cuid())
  taskId    String
  outcomeId String
  task      Task    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  outcome   Outcome @relation(fields: [outcomeId], references: [id], onDelete: Cascade)

  @@unique([taskId, outcomeId])
}

model Release {
  id            String                @id @default(cuid())
  name          String
  description   String?
  level         Float                 @default(1.0)    // Decimal level (1.0, 1.1, 2.0, etc.)
  isActive      Boolean               @default(true)   // Whether this release is currently active
  productId     String?
  solutionId    String?
  customAttrs   Json?                 // For storing productReleaseMapping etc.
  displayOrder  Int                   @default(0)
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  deletedAt     DateTime?
  product       Product?              @relation(fields: [productId], references: [id])
  solution      Solution?             @relation(fields: [solutionId], references: [id])
  tasks         TaskRelease[]
  customerTasks CustomerTaskRelease[]

  @@index([productId, level])
  @@index([solutionId, level])
}

model TaskRelease {
  id        String  @id @default(cuid())
  taskId    String
  releaseId String
  task      Task    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  release   Release @relation(fields: [releaseId], references: [id], onDelete: Cascade)

  @@unique([taskId, releaseId])
}

model SolutionAdoptionPlan {
  id                    String              @id @default(cuid())
  customerSolutionId    String              @unique
  
  // Snapshot of solution details at time of creation
  solutionId            String              // Reference to original solution
  solutionName          String              // Snapshot of solution name
  licenseLevel          LicenseLevel        // License level when created
  selectedOutcomes      Json?               // Outcome IDs when created (solution + product)
  selectedReleases      Json?               // Release IDs when created (solution + product)
  
  // Product inclusion tracking
  includedProductIds    Json                // Array of product IDs included in this solution plan
  
  // Progress tracking (aggregated)
  totalTasks            Int                 @default(0)   // All tasks (solution + all products)
  completedTasks        Int                 @default(0)   // All completed tasks
  totalWeight           Decimal             @default(0) @db.Decimal(10, 2)
  completedWeight       Decimal             @default(0) @db.Decimal(10, 2)
  progressPercentage    Decimal             @default(0) @db.Decimal(5, 2)
  
  // Solution-specific task progress
  solutionTasksTotal    Int                 @default(0)   // Only solution's own tasks
  solutionTasksComplete Int                 @default(0)   // Only solution's own completed tasks
  
  // Metadata
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  lastSyncedAt          DateTime?           // Last time synced with solution/product changes
  
  // Relations
  customerSolution      CustomerSolution    @relation(fields: [customerSolutionId], references: [id], onDelete: Cascade)
  tasks                 CustomerSolutionTask[]
  products              SolutionAdoptionProduct[]  // Track each product's progress within solution
  
  @@index([customerSolutionId])
  @@index([solutionId])
}

model SolutionAdoptionProduct {
  id                    String                  @id @default(cuid())
  solutionAdoptionPlanId String
  productId             String
  productName           String                  // Snapshot
  
  // Ordering and sequencing
  sequenceNumber        Int                     // Order of this product in the solution
  
  // Progress tracking for this product within solution
  totalTasks            Int                     @default(0)
  completedTasks        Int                     @default(0)
  totalWeight           Decimal                 @default(0) @db.Decimal(10, 2)
  completedWeight       Decimal                 @default(0) @db.Decimal(10, 2)
  progressPercentage    Decimal                 @default(0) @db.Decimal(5, 2)
  
  // Status
  status                SolutionProductStatus   @default(NOT_STARTED)  // NOT_STARTED, IN_PROGRESS, COMPLETED, BLOCKED
  
  // Metadata
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  
  // Relations
  solutionAdoptionPlan  SolutionAdoptionPlan    @relation(fields: [solutionAdoptionPlanId], references: [id], onDelete: Cascade)
  
  @@unique([solutionAdoptionPlanId, productId])
  @@index([solutionAdoptionPlanId])
  @@index([productId])
}

model CustomerSolutionTask {
  id                      String                    @id @default(cuid())
  solutionAdoptionPlanId  String
  
  // Task source (either solution task OR product task)
  originalTaskId          String                    // Reference to task (could be solution OR product task)
  sourceType              TaskSourceType            // SOLUTION or PRODUCT
  sourceProductId         String?                   // If source is PRODUCT, which product?
  
  // Snapshot of original task
  name                    String
  description             String?
  estMinutes              Int
  weight                  Decimal                   @db.Decimal(5, 2)
  sequenceNumber          Int                       // Overall sequence in solution (interleaved)
  howToDoc                String[]
  howToVideo              String[]
  notes                   String?
  licenseLevel            LicenseLevel
  
  // Customer-specific status (same as CustomerTask)
  status                  CustomerTaskStatus        @default(NOT_STARTED)
  statusUpdatedAt         DateTime?
  statusUpdatedBy         String?
  statusUpdateSource      StatusUpdateSource?
  statusNotes             String?
  
  // Completion tracking
  isComplete              Boolean                   @default(false)
  completedAt             DateTime?
  completedBy             String?
  
  // Metadata
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt
  
  // Relations
  solutionAdoptionPlan    SolutionAdoptionPlan      @relation(fields: [solutionAdoptionPlanId], references: [id], onDelete: Cascade)
  telemetryAttributes     CustomerTelemetryAttribute[]
  outcomes                CustomerTaskOutcome[]
  releases                CustomerTaskRelease[]
  taskTags                CustomerSolutionTaskTag[]
  
  @@index([solutionAdoptionPlanId])
  @@index([originalTaskId])
  @@index([sourceProductId])
}

model SolutionTaskOrder {
  id              String   @id @default(cuid())
  solutionId      String
  taskId          String
  sourceType      TaskSourceType  // SOLUTION or PRODUCT
  sourceProductId String?         // If PRODUCT, which product
  sequenceNumber  Int             // Global sequence within solution
  
  solution        Solution @relation(fields: [solutionId], references: [id], onDelete: Cascade)
  
  @@unique([solutionId, sequenceNumber])
  @@unique([solutionId, taskId])
  @@index([solutionId])
  @@index([taskId])
}

model Role {
  id          String           @id @default(cuid())
  name        String           @unique
  description String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  userRoles   UserRole[]
  permissions RolePermission[]
}

model UserRole {
  id        String   @id @default(cuid())
  userId    String
  roleId    String?  // New role system - FK to Role table
  roleName  String?  // Deprecated - kept for backward compatibility
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      Role?    @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([roleId])
}

model RolePermission {
  id              String          @id @default(cuid())
  roleId          String
  resourceType    ResourceType
  resourceId      String?         // NULL for "all" resources of this type
  permissionLevel PermissionLevel
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  role            Role            @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  @@unique([roleId, resourceType, resourceId])
  @@index([roleId])
  @@index([resourceType, resourceId])
}

model Permission {
  id              String   @id @default(cuid())
  userId          String
  resourceType    ResourceType
  resourceId      String?  // NULL for system-wide permissions
  permissionLevel PermissionLevel
  grantedBy       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  grantedByUser   User?    @relation("GrantedBy", fields: [grantedBy], references: [id])
  
  @@unique([userId, resourceType, resourceId])
  @@index([userId])
  @@index([resourceType, resourceId])
}

enum ResourceType {
  PRODUCT
  SOLUTION
  CUSTOMER
  SYSTEM
}

enum PermissionLevel {
  READ
  WRITE
  ADMIN
}

// ===================
// SOLUTION TAGS
// ===================

model SolutionTag {
  id           String            @id @default(cuid())
  solutionId   String
  name         String
  description  String?
  color        String?
  displayOrder Int               @default(0)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  
  solution     Solution          @relation(fields: [solutionId], references: [id], onDelete: Cascade)
  taskTags     SolutionTaskTag[]
  
  @@unique([solutionId, name])
  @@index([solutionId])
}

model SolutionTaskTag {
  id        String       @id @default(cuid())
  taskId    String
  tagId     String
  createdAt DateTime     @default(now())
  
  task      Task         @relation(fields: [taskId], references: [id], onDelete: Cascade)
  tag       SolutionTag  @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@unique([taskId, tagId])
  @@index([taskId])
  @@index([tagId])
}

// ===================
// CUSTOMER SOLUTION TAGS
// ===================

model CustomerSolutionTag {
  id                  String           @id @default(cuid())
  customerSolutionId  String
  sourceTagId         String?
  name                String
  description         String?
  color               String?
  displayOrder        Int              @default(0)
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  
  customerSolution    CustomerSolution @relation(fields: [customerSolutionId], references: [id], onDelete: Cascade)
  taskTags            CustomerSolutionTaskTag[]
  
  @@unique([customerSolutionId, name])
  @@index([customerSolutionId])
}

model CustomerSolutionTaskTag {
  id                     String               @id @default(cuid())
  customerSolutionTaskId String
  tagId                  String
  createdAt              DateTime             @default(now())
  
  customerSolutionTask   CustomerSolutionTask @relation(fields: [customerSolutionTaskId], references: [id], onDelete: Cascade)
  tag                    CustomerSolutionTag  @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@unique([customerSolutionTaskId, tagId])
  @@index([customerSolutionTaskId])
  @@index([tagId])
}

model DiaryTodo {
  id             String   @id @default(cuid())
  userId         String
  task           String
  description    String?
  isCompleted    Boolean  @default(false)
  sequenceNumber Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model DiaryBookmark {
  id             String   @id @default(cuid())
  userId         String
  title          String
  url            String
  sequenceNumber Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

#!/bin/bash

# =============================================================================
# DAP Pre-Push Hook
# =============================================================================
# Purpose: Comprehensive validation before pushing to remote
# 
# Checks performed:
#   1. All pre-commit checks
#   2. Full test suite
#   3. Build verification
#
# To bypass (emergency only): git push --no-verify
# =============================================================================

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Header
echo ""
echo -e "${BLUE}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║          DAP Quality Gate - Pre-Push Checks                  ║${NC}"
echo -e "${BLUE}║          Full Validation Before Remote Push                  ║${NC}"
echo -e "${BLUE}╚══════════════════════════════════════════════════════════════╝${NC}"
echo ""

# Track failures
FAILED=0

# Get the root directory
ROOT_DIR=$(git rev-parse --show-toplevel)
cd "$ROOT_DIR"

# =============================================================================
# Check 1: Run Pre-Commit Checks
# =============================================================================
echo -e "${YELLOW}[1/3]${NC} Running pre-commit checks..."

if [ -f "scripts/hooks/pre-commit" ]; then
    if bash scripts/hooks/pre-commit; then
        echo -e "  ${GREEN}✓${NC} Pre-commit checks: PASSED"
    else
        echo -e "  ${RED}✗${NC} Pre-commit checks: FAILED"
        FAILED=1
    fi
else
    echo -e "  ${YELLOW}⚠${NC} Pre-commit hook not found, running basic checks..."
    
    # Basic TypeScript check
    if [ -f "backend/tsconfig.json" ]; then
        cd backend && npx tsc --noEmit && cd "$ROOT_DIR"
    fi
    if [ -f "frontend/tsconfig.json" ]; then
        cd frontend && npx tsc --noEmit && cd "$ROOT_DIR"
    fi
fi

# =============================================================================
# Check 2: Full Test Suite
# =============================================================================
echo ""
echo -e "${YELLOW}[2/3]${NC} Running full test suite..."

# Backend tests
if [ -d "backend" ] && [ -f "backend/package.json" ]; then
    echo -e "  Running backend tests..."
    cd backend
    
    # Check if test script exists
    if npm run test --dry-run 2>/dev/null; then
        if npm run test 2>/dev/null; then
            echo -e "  ${GREEN}✓${NC} Backend tests: PASSED"
        else
            echo -e "  ${RED}✗${NC} Backend tests: FAILED"
            FAILED=1
        fi
    else
        echo -e "  ${YELLOW}⚠${NC} No test script in backend, skipping"
    fi
    cd "$ROOT_DIR"
fi

# Frontend tests (if configured)
if [ -d "frontend" ] && [ -f "frontend/package.json" ]; then
    echo -e "  Running frontend tests..."
    cd frontend
    
    # Check if test script exists and is not just a placeholder
    if grep -q '"test"' package.json && ! grep -q '"test": "echo' package.json; then
        if npm run test 2>/dev/null; then
            echo -e "  ${GREEN}✓${NC} Frontend tests: PASSED"
        else
            echo -e "  ${YELLOW}⚠${NC} Frontend tests: Some tests may have failed (non-blocking)"
        fi
    else
        echo -e "  ${YELLOW}⚠${NC} No test script in frontend, skipping"
    fi
    cd "$ROOT_DIR"
fi

# =============================================================================
# Check 3: Build Verification
# =============================================================================
echo ""
echo -e "${YELLOW}[3/3]${NC} Verifying builds..."

# Backend build
if [ -d "backend" ] && [ -f "backend/package.json" ]; then
    echo -e "  Building backend..."
    cd backend
    
    if npm run build 2>/dev/null; then
        echo -e "  ${GREEN}✓${NC} Backend build: PASSED"
    else
        echo -e "  ${RED}✗${NC} Backend build: FAILED"
        FAILED=1
    fi
    cd "$ROOT_DIR"
fi

# Frontend build
if [ -d "frontend" ] && [ -f "frontend/package.json" ]; then
    echo -e "  Building frontend..."
    cd frontend
    
    if npm run build 2>/dev/null; then
        echo -e "  ${GREEN}✓${NC} Frontend build: PASSED"
    else
        echo -e "  ${RED}✗${NC} Frontend build: FAILED"
        FAILED=1
    fi
    cd "$ROOT_DIR"
fi

# =============================================================================
# Final Result
# =============================================================================
echo ""
echo -e "${BLUE}══════════════════════════════════════════════════════════════${NC}"

if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}✓ All pre-push checks PASSED${NC}"
    echo -e "${GREEN}  Push proceeding...${NC}"
    echo ""
    exit 0
else
    echo -e "${RED}✗ Pre-push checks FAILED${NC}"
    echo -e "${RED}  Please fix the issues above before pushing.${NC}"
    echo ""
    echo -e "${YELLOW}To bypass (emergency only): git push --no-verify${NC}"
    echo -e "${YELLOW}See docs/QUALITY_STANDARDS.md for guidance${NC}"
    echo ""
    exit 1
fi

